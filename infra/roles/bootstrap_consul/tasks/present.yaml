---
- name: Generate future id
  ansible.builtin.set_fact:
    future_id: "{{ deployment_id if deployment_id is defined else lookup('pipe', 'cat /proc/sys/kernel/random/uuid')[:8] }}"
- name: Set deployment id
  ansible.builtin.set_fact:
    deployment_id: "{{ future_id }}"
- name: Create future names
  ansible.builtin.set_fact:
    future_pod_name: "{{ env + '-' + service_name  + '-' +  future_id }}"
    future_app_container_name: "{{ env + '-' + service_name  + '-' +  future_id + '-app' }}"
    future_mesh_container_name: "{{ env + '-' + service_name  + '-' +  future_id + '-mesh' }}"
    future_shell_container_name: "{{ env + '-' + service_name  + '-' +  future_id + '-shell' }}"
- name: Deploy consul pod
  ansible.builtin.include_role:
    name: podman-pod
    tasks_from: present
  vars:
    pod_name: "{{ future_pod_name }}"
    pod_publish:
      - "8500:8500"
- name: Deploy consul container
  ansible.builtin.include_role:
    name: podman-container
    tasks_from: present
  vars:
    container_name: "{{ future_app_container_name }}"
    container_pod: "{{ future_pod_name }}"
    container_image: "registry.lab.skarbek.name/bootstrap/consul:latest"
    container_catatonit: false
- name: Start consul pod
  ansible.builtin.include_role:
    name: podman-pod
    tasks_from: started
  vars:
    pod_name: "{{ future_pod_name }}"
- name: Start consul container
  ansible.builtin.include_role:
    name: podman-container
    tasks_from: started
  vars:
    container_name: "{{ future_app_container_name }}"
