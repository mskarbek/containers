---
- hosts: all
  gather_facts: false
  vars:
    #deployment_id: 78a9fe33
    consul_host: &consul_opts
      #host: "consul.lab.skarbek.name"
      host: 127.0.0.1
      #port: "443"
      #scheme: "https"
      validate_certs: no
  vars_files:
    - "{{ env }}.yaml"
  tasks:
    - name: Deploy consul
      ansible.builtin.include_role:
        name: bootstrap-consul
        tasks_from: present
      vars:
        service_name: consul
    - name: Add default pause image
      community.general.consul_kv:
        <<: *consul_opts
        key: "{{ item }}"
        value: "registry.lab.skarbek.name/pause:8.5-1"
      loop:
        - "all/defaults/pause_image"
    - name: Add default registry url
      community.general.consul_kv:
        <<: *consul_opts
        key: "{{ item }}"
        value: "registry.lab.skarbek.name"
      loop:
        - "all/defaults/registry_url"
